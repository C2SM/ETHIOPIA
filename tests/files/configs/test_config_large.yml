---
start_date: &root_start_date '2025-01-01T00:00'
end_date: &root_end_date '2027-01-01T00:00'
cycles:
  - init:
      tasks:
        - extpar:
            inputs: [obs_data]
            outputs: [extpar_file]
  - icon_bimonthly:
      start_date: *root_start_date
      end_date: *root_end_date
      period: 'P2M'
      tasks:
        - preproc:
            inputs: [grid_file, extpar_file, ERA5]
            outputs: [icon_input]
            wait_on:
              - icon:
                  when:
                    after: '2025-03-01T00:00'
                  lag: '-P4M'
        - icon:
            inputs:
              - grid_file
              - icon_input
              - icon_restart:
                  when:
                    after: *root_start_date
                  lag: '-P2M'
            outputs: [stream_1, stream_2, icon_restart]
        - postproc_1:
            inputs: [stream_1]
            outputs: [postout_1]
        - store_and_clean_1:
            inputs: [postout_1, stream_1, icon_input]
            outputs: [stored_data_1]
  - yearly:
      start_date: *root_start_date
      end_date: *root_end_date
      period: 'P1Y'
      tasks:
        - postproc_2:
            inputs:
              - stream_2:
                  lag: ['P0M', 'P2M', 'P4M', 'P6M', 'P8M', 'P10M']
            outputs: [postout_2]
        - store_and_clean_2:
            inputs:
              - postout_2
              - stream_2:
                  lag: ['P0M', 'P2M', 'P4M', 'P6M', 'P8M', 'P10M']
            outputs:
              - stored_data_2
# Each task and piece of data (input and output of tasks) used to
# define the graph is described in that section
tasks:
  - ROOT:
      # All tasks inherit the root task properties
      host: santis
      account: g110
  - extpar:
      plugin: shell  # no extpar plugin available yet
      command: $PWD/examples/files/scripts/extpar
      cli_arguments:
        keyword:
          --input: obs_data
        flags:
          - --verbose
      uenv:
        squashfs: path/to/squashfs
        mount_point: runtime/mount/point
      nodes: 1
      walltime: 00:02:00
  - preproc:
      plugin: shell
      command: $PWD/examples/files/scripts/cleanup.sh
      cli_arguments:
        positional:
          - grid_file
        keyword:
          -p: extpar_file
          -e: ERA5
        source_file: dummy_source_file
      nodes: 4
      walltime: 00:02:00
      uenv:
        squashfs: path/to/squashfs
        mount_point: runtime/mount/point
  - icon:
      plugin: icon
      command: $PWD/examples/files/scripts/icon
      cli_arguments:
        keyword:
          -g: grid_file
          --input: icon_input
      nodes: 40
      walltime: 23:59:59
      namelists:
        master: path/to/mater_nml
        model: path/to/model_nml
      uenv:
        squashfs: path/to/squashfs
        mount_point: runtime/mount/point
  - postproc_1:
      plugin: shell
      command: $PWD/examples/files/scripts/main_script_ocn.sh
      cli_arguments:
        keyword:
          --input: stream_1
      nodes: 2
      walltime: 00:05:00
      uenv:
        squashfs: path/to/squashfs
        mount_point: runtime/mount/point
  - postproc_2:
      plugin: shell
      command: $PWD/examples/files/scripts/main_script_atm.sh
      cli_arguments:
        keyword:
          --input: stream_2
          # `arg_option` should be in `tasks` section instead
          # How to implement this? Even needed with keyword-arguments?
          # arg_option: --input
      nodes: 2
      walltime: 00:05:00
      src: path/to/src/dir
      uenv:
        squashfs: path/to/squashfs
        mount_point: runtime/mount/point
  - store_and_clean_1:
      plugin: shell
      command: $PWD/examples/files/scripts/post_clean.sh
      cli_arguments:
        keyword:
          --input: postout_1
          --stream: stream_1
          --icon_input: icon_input
      nodes: 1
      walltime: 00:01:00
  - store_and_clean_2:
      plugin: shell
      command: $PWD/examples/files/scripts/post_clean.sh
      cli_arguments:
        keyword:
          --input: postout_2
      nodes: 1
      walltime: 00:01:00
data:
  available:
    - grid_file:
        type: file
        src: $PWD/examples/files/data/grid
    - obs_data:
        type: file
        src: $PWD/examples/files/data/obs_data
    - ERA5:
        type: file
        src: $PWD/examples/files/data/era5
    - dummy_source_file:
        type: file
        src: $PWD/examples/files/data/dummy_source_file.sh
  generated:
    - extpar_file:
        type: file
        src: output
    - icon_input:
        type: file
        src: output
    - icon_restart:
        type: file
        format: ncdf
        src: restart
    - stream_1:
        type: file
        src: output_1
    - stream_2:
        type: file
        src: output_2
    - postout_1:
        type: file
        src: postout
    - postout_2:
        type: file
        src: postout
    - stored_data_1:
        type: file
        src: stored_data
    - stored_data_2:
        type: file
        src: stored_data
